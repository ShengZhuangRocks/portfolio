---
title: "about session and cookie"
author: "Sheng Zhuang"
date: "07/03/2021"
stack: "Session Cookie"
---

what is session

what is cookie

---

how session work?

node.js

express-session middleware

```js
import session from "express-session";

const sessionMiddleware = session(sessionConfig);
app.use(sessionMiddleware); // express app
```

get data from session

```js
req.session.key;
```

store or set data to session

```js
req.session.key = value;
```

destroy a session

```js
req.session.destroy(CB);
```

---

handler | resolver express-session
login -> req.session.userId=user.id -> new session -> new req.sessionID: '3RG9hsMIFqqg...'
-> saved to Redis -> key: "sess:3hjk435o5u..."
-> redis key + secret -> cookie
-> send a cookie in header to client
cookie: "prefix:fsiouerjkl14o..."

me | isAuthenticated
client -> req
-> cookie in header -> unsigncookie -> Redis key -> get session -> req.session ->
-> if(req.session.userId) -> user data -> client

logout
client -> req
-> cookie in header -> unsigncookie -> Redis key -> get session -> req.session ->
-> req.session.destroy(CB)

sheng: not so sure if req.sessionID == redis item key? is whole session saved to redis or just userId k-v pair?
if session is not saved to redis? then where?

no, sessionID is generated by express-session, and will be stored in Redis

The session is stored in the express server itself, as global variable by default
The default server-side session storage, MemoryStore, is purposely not designed for a production environment.

This can be solved by using external Session Store. We have to store every session in the store so that each one will belong to only a single user. One popular session store is built using the Redis.

After submitting the server generates a unique random number, known as the session ID, which is also stored on the Reids store.

---

setcookie and unsigncookie from source code

```js
function setcookie(res, name, val, secret, options) {
  var signed = "s:" + signature.sign(val, secret);
  var data = cookie.serialize(name, signed, options);

  debug("set-cookie %s", data);

  var prev = res.getHeader("set-cookie") || [];
  var header = Array.isArray(prev) ? prev.concat(data) : [prev, data];

  res.setHeader("set-cookie", header);
}
```

```js
function unsigncookie(val, secrets) {
  for (var i = 0; i < secrets.length; i++) {
    var result = signature.unsign(val, secrets[i]);

    if (result !== false) {
      return result;
    }
  }

  return false;
}
```

---

REST Api handler

```js
// handler
(req, res) => (req.session.userId = user.id);
```

graphql Resolver

```js
(args, context:{req, res, ...rest}) => req.session.userId = user.id
```

---

```js
new ApolloServer({
  ...
  context: ({req, res}) => ({
    req,
    res,
    redis, // add redis to context
    ...
  })
  ...
})
```

---

```
Request Headers:
              url encoded
  Cookie: qid=s%3ASlHAnZY-IdoBiHzLkWuXmgXPIlyL7Duu.8FXOtia6juBDZGUObO7tacT2zSsq9XwFjdYq%2BiUNmmY
                  url decoded
  cookies["qid"]: s:SlHAnZY-IdoBiHzLkWuXmgXPIlyL7Duu.8FXOtia6juBDZGUObO7tacT2zSsq9XwFjdYq%2BiUNmmY
  split
  s: | req.sessionId | . | 8FXOtia6juBDZGUObO7tacT2zSsq9XwFjdYq%2BiUNmmY

  val = unsingcookie(SlHAnZY-IdoBiHzLkWuXmgXPIlyL7Duu.8FXOtia6juBDZGUObO7tacT2zSsq9XwFjdYq%2BiUNmmY, secrets)
```
